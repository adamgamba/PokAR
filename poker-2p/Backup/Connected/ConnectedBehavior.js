//@input SceneObject optionalTarget
//@ui {"widget":"group_start", "label":"Scene Object"}
//@input bool bindEnable = false
//@input string enableMode { "showIf":"bindEnable", "showIfValue":true, "widget":"combobox", "values":[{ "label": "Enable", "value": "" },  { "label": "Disable", "value": "disable" }] }
//@input string enableOnFlowStates  { "showIf":"bindEnable", "showIfValue":true, "label":"To FlowState", "widget":"combobox", "values":[{ "label": "none", "value": "none" }, { "label": "NOT_SET", "value": "not set" },{ "label": "SESSION_TYPE_SELECT", "value": "session type select" }, { "label": "PROMPT_TO_CREATE_COLOCATED", "value": "prompt to create colocated" },{ "label": "CREATING_COLOCATED", "value": "creating colocated" },{ "label": "UPLOADING_COLOCATED", "value": "uploading colocated" }, { "label": "COLOCATED_CREATED_SNAPCODE", "value": "colocated created snapcode" }, { "label": "INITIATOR_WAITING_FOR_TRACKING", "value": "initiator waiting for tracking" }, { "label": "JOINER_WAITING_FOR_TRACKING", "value": "joiner waiting for tracking" }, { "label": "DONE", "value": "done" }, { "label": "RESHOW_SNAPCODE", "value": "reshow snapcode" },{ "label": "ERRORED", "value": "error" }, { "label": "DOWNLOADING_COLOCATED", "value": "downloading colocated" }] }
//@input string enableOnFlowStates2 { "showIf":"bindEnable", "showIfValue":true, "label":"To FlowState", "widget":"combobox", "values":[{ "label": "none", "value": "none" }, { "label": "NOT_SET", "value": "not set" },{ "label": "SESSION_TYPE_SELECT", "value": "session type select" }, { "label": "PROMPT_TO_CREATE_COLOCATED", "value": "prompt to create colocated" },{ "label": "CREATING_COLOCATED", "value": "creating colocated" },{ "label": "UPLOADING_COLOCATED", "value": "uploading colocated" }, { "label": "COLOCATED_CREATED_SNAPCODE", "value": "colocated created snapcode" }, { "label": "INITIATOR_WAITING_FOR_TRACKING", "value": "initiator waiting for tracking" }, { "label": "JOINER_WAITING_FOR_TRACKING", "value": "joiner waiting for tracking" }, { "label": "DONE", "value": "done" }, { "label": "RESHOW_SNAPCODE", "value": "reshow snapcode" },{ "label": "ERRORED", "value": "error" }, { "label": "DOWNLOADING_COLOCATED", "value": "downloading colocated" }] }
//@input string enableOnFlowStates3 { "showIf":"bindEnable", "showIfValue":true, "label":"To FlowState", "widget":"combobox", "values":[{ "label": "none", "value": "none" }, { "label": "NOT_SET", "value": "not set" },{ "label": "SESSION_TYPE_SELECT", "value": "session type select" }, { "label": "PROMPT_TO_CREATE_COLOCATED", "value": "prompt to create colocated" },{ "label": "CREATING_COLOCATED", "value": "creating colocated" },{ "label": "UPLOADING_COLOCATED", "value": "uploading colocated" }, { "label": "COLOCATED_CREATED_SNAPCODE", "value": "colocated created snapcode" }, { "label": "INITIATOR_WAITING_FOR_TRACKING", "value": "initiator waiting for tracking" }, { "label": "JOINER_WAITING_FOR_TRACKING", "value": "joiner waiting for tracking" }, { "label": "DONE", "value": "done" }, { "label": "RESHOW_SNAPCODE", "value": "reshow snapcode" },{ "label": "ERRORED", "value": "error" }, { "label": "DOWNLOADING_COLOCATED", "value": "downloading colocated" }] }
//@input string enableOnFlowStates4 { "showIf":"bindEnable", "showIfValue":true, "label":"To FlowState", "widget":"combobox", "values":[{ "label": "none", "value": "none" }, { "label": "NOT_SET", "value": "not set" },{ "label": "SESSION_TYPE_SELECT", "value": "session type select" }, { "label": "PROMPT_TO_CREATE_COLOCATED", "value": "prompt to create colocated" },{ "label": "CREATING_COLOCATED", "value": "creating colocated" },{ "label": "UPLOADING_COLOCATED", "value": "uploading colocated" }, { "label": "COLOCATED_CREATED_SNAPCODE", "value": "colocated created snapcode" }, { "label": "INITIATOR_WAITING_FOR_TRACKING", "value": "initiator waiting for tracking" }, { "label": "JOINER_WAITING_FOR_TRACKING", "value": "joiner waiting for tracking" }, { "label": "DONE", "value": "done" }, { "label": "RESHOW_SNAPCODE", "value": "reshow snapcode" },{ "label": "ERRORED", "value": "error" }, { "label": "DOWNLOADING_COLOCATED", "value": "downloading colocated" }] }
//@input string enableOnFlowStates5 { "showIf":"bindEnable", "showIfValue":true, "label":"To FlowState", "widget":"combobox", "values":[{ "label": "none", "value": "none" }, { "label": "NOT_SET", "value": "not set" },{ "label": "SESSION_TYPE_SELECT", "value": "session type select" }, { "label": "PROMPT_TO_CREATE_COLOCATED", "value": "prompt to create colocated" },{ "label": "CREATING_COLOCATED", "value": "creating colocated" },{ "label": "UPLOADING_COLOCATED", "value": "uploading colocated" }, { "label": "COLOCATED_CREATED_SNAPCODE", "value": "colocated created snapcode" }, { "label": "INITIATOR_WAITING_FOR_TRACKING", "value": "initiator waiting for tracking" }, { "label": "JOINER_WAITING_FOR_TRACKING", "value": "joiner waiting for tracking" }, { "label": "DONE", "value": "done" }, { "label": "RESHOW_SNAPCODE", "value": "reshow snapcode" },{ "label": "ERRORED", "value": "error" }, { "label": "DOWNLOADING_COLOCATED", "value": "downloading colocated" }] }
//@input string enableOnFlowStates6 { "showIf":"bindEnable", "showIfValue":true, "label":"To FlowState", "widget":"combobox", "values":[{ "label": "none", "value": "none" }, { "label": "NOT_SET", "value": "not set" },{ "label": "SESSION_TYPE_SELECT", "value": "session type select" }, { "label": "PROMPT_TO_CREATE_COLOCATED", "value": "prompt to create colocated" },{ "label": "CREATING_COLOCATED", "value": "creating colocated" },{ "label": "UPLOADING_COLOCATED", "value": "uploading colocated" }, { "label": "COLOCATED_CREATED_SNAPCODE", "value": "colocated created snapcode" }, { "label": "INITIATOR_WAITING_FOR_TRACKING", "value": "initiator waiting for tracking" }, { "label": "JOINER_WAITING_FOR_TRACKING", "value": "joiner waiting for tracking" }, { "label": "DONE", "value": "done" }, { "label": "RESHOW_SNAPCODE", "value": "reshow snapcode" },{ "label": "ERRORED", "value": "error" }, { "label": "DOWNLOADING_COLOCATED", "value": "downloading colocated" }] }
//@input string enableOnFlowStates7 { "showIf":"bindEnable", "showIfValue":true, "label":"To FlowState", "widget":"combobox", "values":[{ "label": "none", "value": "none" }, { "label": "NOT_SET", "value": "not set" },{ "label": "SESSION_TYPE_SELECT", "value": "session type select" }, { "label": "PROMPT_TO_CREATE_COLOCATED", "value": "prompt to create colocated" },{ "label": "CREATING_COLOCATED", "value": "creating colocated" },{ "label": "UPLOADING_COLOCATED", "value": "uploading colocated" }, { "label": "COLOCATED_CREATED_SNAPCODE", "value": "colocated created snapcode" }, { "label": "INITIATOR_WAITING_FOR_TRACKING", "value": "initiator waiting for tracking" }, { "label": "JOINER_WAITING_FOR_TRACKING", "value": "joiner waiting for tracking" }, { "label": "DONE", "value": "done" }, { "label": "RESHOW_SNAPCODE", "value": "reshow snapcode" },{ "label": "ERRORED", "value": "error" }, { "label": "DOWNLOADING_COLOCATED", "value": "downloading colocated" }] }
//@input string enableOnFlowStates8 { "showIf":"bindEnable", "showIfValue":true, "label":"To FlowState", "widget":"combobox", "values":[{ "label": "none", "value": "none" }, { "label": "NOT_SET", "value": "not set" },{ "label": "SESSION_TYPE_SELECT", "value": "session type select" }, { "label": "PROMPT_TO_CREATE_COLOCATED", "value": "prompt to create colocated" },{ "label": "CREATING_COLOCATED", "value": "creating colocated" },{ "label": "UPLOADING_COLOCATED", "value": "uploading colocated" }, { "label": "COLOCATED_CREATED_SNAPCODE", "value": "colocated created snapcode" }, { "label": "INITIATOR_WAITING_FOR_TRACKING", "value": "initiator waiting for tracking" }, { "label": "JOINER_WAITING_FOR_TRACKING", "value": "joiner waiting for tracking" }, { "label": "DONE", "value": "done" }, { "label": "RESHOW_SNAPCODE", "value": "reshow snapcode" },{ "label": "ERRORED", "value": "error" }, { "label": "DOWNLOADING_COLOCATED", "value": "downloading colocated" }] }
//@input string enableOnFlowStates9 { "showIf":"bindEnable", "showIfValue":true, "label":"To FlowState", "widget":"combobox", "values":[{ "label": "none", "value": "none" }, { "label": "NOT_SET", "value": "not set" },{ "label": "SESSION_TYPE_SELECT", "value": "session type select" }, { "label": "PROMPT_TO_CREATE_COLOCATED", "value": "prompt to create colocated" },{ "label": "CREATING_COLOCATED", "value": "creating colocated" },{ "label": "UPLOADING_COLOCATED", "value": "uploading colocated" }, { "label": "COLOCATED_CREATED_SNAPCODE", "value": "colocated created snapcode" }, { "label": "INITIATOR_WAITING_FOR_TRACKING", "value": "initiator waiting for tracking" }, { "label": "JOINER_WAITING_FOR_TRACKING", "value": "joiner waiting for tracking" }, { "label": "DONE", "value": "done" }, { "label": "RESHOW_SNAPCODE", "value": "reshow snapcode" },{ "label": "ERRORED", "value": "error" }, { "label": "DOWNLOADING_COLOCATED", "value": "downloading colocated" }] }
//@ui {"widget":"group_end"}

//@ui {"widget":"group_start", "label":"Building Progress"}
//@input bool bindUniform = false
//@input Component.Image image { "showIf":"bindUniform", "showIfValue": "true" }
//@input string uniformName { "showIf":"bindUniform", "showIfValue": "true" } 
//@ui {"widget":"group_end"}

//@ui {"widget":"group_start", "label":"Snap Code"}
//@input bool bindSnapCode = false
//@input Component.Image snapCodeImage { "showIf":"bindSnapCode", "showIfValue": "true" }
//@input bool bindEnableToHasSnapcode
//@ui {"widget":"group_end"}

//@ui {"widget":"group_start", "label":"Error messages"}
//@input bool bindErrorMessageToText = false
//@input Component.Text textForErrorMessage { "showIf":"bindErrorMessageToText", "showIfValue": "true" }
//@ui {"widget":"group_end"}

//@ui {"widget":"group_start", "label":"Text"}
//@input bool bindFlowStateToText = false;
//@ui {"widget":"group_end"}

//@ui {"widget":"group_start", "label":"Call script api"}
//@input bool callScriptApi = false;
//@input string callApiOnState { "showIf":"callScriptApi", "showIfValue":true, "label":"To FlowState", "widget":"combobox", "values":[{ "label": "none", "value": "none" }, { "label": "NOT_SET", "value": "not set" },{ "label": "SESSION_TYPE_SELECT", "value": "session type select" }, { "label": "PROMPT_TO_CREATE_COLOCATED", "value": "prompt to create colocated" },{ "label": "CREATING_COLOCATED", "value": "creating colocated" },{ "label": "UPLOADING_COLOCATED", "value": "uploading colocated" }, { "label": "COLOCATED_CREATED_SNAPCODE", "value": "colocated created snapcode" }, { "label": "INITIATOR_WAITING_FOR_TRACKING", "value": "initiator waiting for tracking" }, { "label": "JOINER_WAITING_FOR_TRACKING", "value": "joiner waiting for tracking" }, { "label": "DONE", "value": "done" }, { "label": "RESHOW_SNAPCODE", "value": "reshow snapcode" },{ "label": "ERRORED", "value": "error" }, { "label": "DOWNLOADING_COLOCATED", "value": "downloading colocated" }] }
//@input Component.Script callApiScript { "showIf":"callScriptApi", "showIfValue": true, "label": "script" }
//@input string callApiFunctionName { "showIf":"callScriptApi", "showIfValue": true, "label": "function" }
//@ui {"widget":"group_end"}

//@ui {"widget":"group_start", "label":"Session Type"}
//@input bool bindEnableToSessionType
//@input string sessionTypeEnableMode { "showIf":"bindEnableToSessionType", "showIfValue":true, "widget":"combobox", "values":[{ "label": "Enable", "value": "" },  { "label": "Disable", "value": "disable" }] }
//@input string sessionType { "showIf":"bindEnableToSessionType", "showIfValue":true, "widget":"combobox", "values":[{ "label": "NOT_SET", "value": "not set" },  { "label": "REMOTE", "value": "remote" },  { "label": "COLOCATED", "value": "colocated" }] }
//@ui {"widget":"group_end"}

const utils = global.utils;

var flowStates = 
    [script.enableOnFlowStates, script.enableOnFlowStates1, script.enableOnFlowStates2, script.enableOnFlowStates3, script.enableOnFlowStates4,
     script.enableOnFlowStates5, script.enableOnFlowStates6, script.enableOnFlowStates7, script.enableOnFlowStates8, script.enableOnFlowStates9];

var snapCodeTexture = null;
var makeQrCode;
var errorMessage = "";
var hasAttemptedFullscreen = false;
var hasTriggeredGamesUI = false;
var lastFlowStateText = "";

const connectedController = global.connectedController;
connectedController.api.onStateChange(updateBasedOnState);
updateBasedOnState(global.connectedController.api.getState());

var callApi = utils.once(function () {
    script.callApiScript.api[script.callApiFunctionName]();
});
    
function getTarget() {
    if(script.optionalTarget) {return script.optionalTarget;} 
    else { return script.getSceneObject(); }
}    

function updateBasedOnState( state ) {

    //Clear up if this object is destroyed
    if (isNull(script)) {
        connectedController.api.removeOnStateChange(updateBasedOnState);
        return;
    }

    if (script.bindEnable) {
        var shouldDisable = script.enableMode === 'disable';
        var matches = flowStates.indexOf(state.flowState) > -1;
        var targetEnabledState = matches ? !shouldDisable : shouldDisable;

        if( getTarget().enabled !== targetEnabledState )
        {
            getTarget().enabled = targetEnabledState;
        }
    }

    if (script.bindUniform) {
        script.image.mainPass[script.uniformName] = state.mapBuildingProgress;  
    }

    if (script.bindSnapCode && state.snapCodeTexture !== snapCodeTexture) {
        snapCodeTexture = state.snapCodeTexture;
        try {
            script.snapCodeImage.mainPass.baseTex = snapCodeTexture;
        } catch (err) {
            print('Snapcode cannot be set:'+ err);
        }
    }

    if (script.bindErrorMessageToText && state.errorMessage !== errorMessage) {
        errorMessage = state.errorMessage;
        script.textForErrorMessage.text = errorMessage;
    }

    if (script.bindFlowStateToText && state.flowState !== lastFlowStateText) {
        lastFlowStateText = state.flowState;
        script.getSceneObject().getComponent('Text').text  = lastFlowStateText;
    }

    if (script.callScriptApi && state.flowState === script.callApiOnState) {
        callApi();
    }

    if (script.bindEnableToHasSnapcode) {
        getTarget().enabled = state.snapCodeTexture !== null
    }

    if (script.bindEnableToSessionType) {
        var matches = state.sessionType === script.sessionType;
        var action = script.sessionTypeEnableMode === '';
        getTarget().enabled = matches ? action : !action;
    }
}